# RSpecVSCodeFormatter
An RSpec 3.x custom output formatter intended to play a little more friendly with [VSCode v1.14+ (currently v1.19.1) Tasks](https://code.visualstudio.com/docs/editor/tasks). This was quickly strung together to solve my troubles using the [VSCode Task Problem Matchers](https://code.visualstudio.com/docs/editor/tasks#_defining-a-problem-matcher). _It is in no way a well-designed, flexible, tested, or even particularly good, RSpec custom output formatter._ It simply addresses problems I had when I couldn't get existing RSpec output formatters (specifically, the failure dumps,) and VSCode's Task Problem Matchers to consistantly play together nicely.

All I wanted:
* A VSCode Task that would execute the current spec file I was working on
* That same VSCode Task's Problem Matcher to match on failures and provide clean output to the _Problems_ panel.

The trouble is that VSCode's Task Problem Matchers expect nice and tightly grouped error messages in order to work.  Their matchers, [as the documentation describes](https://code.visualstudio.com/docs/editor/tasks#_defining-a-problem-matcher), work on a single line at a time.  This is sufficient for most situations, and when it's not they've also implemented [multi-line matchers](https://code.visualstudio.com/docs/editor/tasks#_defining-a-multiline-problem-matcher). However, they are still dependant on fairly consistant output formatting, and the nature of RSpec failure output doesn't lend itself well to that.  Your custom Problem Matcher must always provide at a minimum, a file, line number, and a message. You can match this information across multiple lines, but it must always be in the same order, and without multi-line/end-of-line-ignoring regex matching, this becomes difficult quickly.

Case in point, here's two example test-failures generated by RSpec's _documenation_ formatter:

``` shell
jtpoll:~/code$ rspec --format documentation spec/lib/my_spec.rb
..................

Failures:

  1) VendorApi::Communicator::Rest::Base protected methods #prepare_request relies on #join_url_and_path to prepare the Typhoeus::Request url
     Failure/Error: expect(true).to eq(false)

       expected: false
            got: true

       (compared using ==)
     # ./spec/lib/vendor_api/communicator/rest/base_spec.rb:64:in `block (4 levels) in <top (required)>'
     # ./spec/rails_helper.rb:89:in `block (3 levels) in <top (required)>'
     # ./spec/rails_helper.rb:88:in `block (2 levels) in <top (required)>'

  2) VendorApi::Communicator::Rest::Base #prepare_request relies on #request_arguments to prepare the Typhoeus::Request
     Failure/Error: Typhoeus::Request.new(full_url, req_args)

       #<Typhoeus::Request (class)> received :new with unexpected arguments
         expected: ("/creamed_corn.json", {:method=>:madness})
              got: ("https://cornhub.com/api/creamed_corn.json", {:method=>:madness})
       Diff:
       @@ -1,2 +1,2 @@
       -["/creamed_corn.json", {:method=>:madness}]
       +["https://cornhub.com/api/creamed_corn.json", {:method=>:madness}]

     # ./app/lib/vendor_api/communicator/rest/base.rb:35:in `prepare_request'
     # ./spec/lib/vendor_api/communicator/rest/base_spec.rb:72:in `block (4 levels) in <top (required)>'
     # ./spec/rails_helper.rb:89:in `block (3 levels) in <top (required)>'
     # ./spec/rails_helper.rb:88:in `block (2 levels) in <top (required)>'
```

In _Failure 1_, I want the first line of the backtrace and it's line number for the Task Problem Matcher's _file_ and _line_ values. I would like all the lines from _"1)"_ up to the stack trace as my error, but with the single-line matchers, I was able to only come up with a Problem Matcher that was able to consistantly grab "_(compared using ==)"_.

In _Failure 2_, the output is different to the point where I was never able to successfully match _file_, _line_ and _message_. Even the failing file and it's line number are not at the top of the stack/backtrace dump. This ended up being the type of test failure that finally resulted in my creation of this output formatter.

Here is the same test failures as above when output by this formatter:
```
jtpoll:~/code/napi (ticketing)$ rspec --require ./.vscode/rspec_vscode_formmater.rb --format RSpecVSCodeFormatter spec/lib/my_spec.rb
TestEnvNumber: rspec
TestCount: 29
PendingCount: 0
FailureCount: 2
TestDuration: 0.189648
TestStarted: 2018-01-27T18:11:54-06:00
HostName: LAP1282.local
TestSeed: 56904
TestFailure: TestFile:./spec/lib/vendor_api/communicator/rest/base_spec.rb Line:64 Message: |expected: false|     got: true||(compared using ==)
TestFailure: TestFile:./spec/lib/vendor_api/communicator/rest/base_spec.rb Line:72 Message: #<Typhoeus::Request (class)> received :new with unexpected arguments|  expected: ("/creamed_corn.json", {:method=>:madness})|       got: ("https://neatapp.zendesk.com/api/v2/creamed_corn.json", {:method=>:madness})|Diff:|@@ -1,2 +1,2 @@|-["/creamed_corn.json", {:method=>:madness}]|+["https://neatapp.zendesk.com/api/v2/creamed_corn.json", {:method=>:madness}]
```

There's very little useful output, actually other than the single-line failure messages.  The only catch is that the multi-line test failure message has to be concatenated into a single line.  I've used `|` for a delimiter.  Regardless, this output is patterend enough that a simple regexp can capture everything the Task Problem Matcher needs:

``` regex
^TestFailure:\\s+TestFile:(\\S+)\\s+Line:(\\d+)\\s+Message:(.*)$
```

# Usage
Assuming you already have RSpec all setup and configured:

```
rspec --require path/to/rspec_vscode_formatter.rb --format RSpecVSCodeFormatter
```

Or append to your .rspec file:
```
--require path/to/rspec_vscode_formatter.rb --format RSpecVSCodeFormatter
```

Take a look at the included tasks.json for an example VSCode Task that makes use of this formatter.


# Roadmap
I have little to no plans for this.  If you would like to see this expanded, changed, or contribute, please let me know.

Heck, if you know of something that scratches this particular problem I had with RSpec and VSCode Task Problem Matchers, please let me know. (It wouldn't be the first time I built myself a solution only to find out someone has alread done it, and better.) `¯\_(ツ)_/¯`

Ok, maybe one small idea: package this up in a gem for easy portability.

# Credit
Because I was in a hurry, I didn't dive very deeply into the [RSpec Custom Output Formatter documenation](https://relishapp.com/rspec/rspec-core/docs/formatters/custom-formatters) like I should have, and borrowed _heavily_ from [Samuel Cochran's RSpecJunitFormatter](https://github.com/sj26/rspec_junit_formatter) which I have put to much use in my work with [Jenkins](https://jenkins.io/) and [CircleCI](https://circleci.com). Thanks, Sam.